### 背景

最近遇到的线上问题，这是在发布过程当中踩到的一个坑。因为，我觉得还是比较有代表性的，不仅涉及到架构设计上的一些合理性，也包括研发流程当中的一些规范，所以在这里和大家一起分享。

我先简单描述一下当时的现象：

现象1：我们正在进行线上发布发现有部分接口报错，但是这个报错是线上还没有发布的这些节点报出来的。

现象2：我们在发布的过程当中发现有部分节点启动不起来。

可能大家认为是发布导致的马上就进行回滚操作，但是这里情况不太一样，直接回滚的话是没有什么用的。或者说这里面根本没有回滚这么一种说法，为什么会这么说呢？接下来我跟大家分析一下这里面的主要原因。

### 部署类型

现在大部分互联网公司，一般分以下几种发布的方式：**滚动发布、灰度发布、蓝绿发布**。

- **滚动发布**

  一般是取出一个或者多个服务器停止服务，执行更新，并重新将其投入使用。周而复始，直到集群中所有的实例都更新成新版本。

  ![img](http://assets.processon.com/chart_image/636458995653bb5ba3609471.png)

  **发布流程**

  相对于蓝绿发布需要一套完备的机器不同，滚动发布只需要一台机器（这儿这是为了理解，实际可能是多台），我们只需要将部分功能部署在这台机器上，然后去替换正在运行的机器，如上图，将更新后的功能部署在Server1上，然后Server1去替换正在运行的Server，替换下来的物理机又可以继续部署Server2的新版本，然后去替换正在工作的Server2，以此类推，直到替换完所有的服务器，至此，服务更新完成。

  **特点说明**

  1. 这种部署方式相对于蓝绿部署，更加节约资源——它不需要运行两个集群、两倍的实例数。我们可以部分部署，例如每次只取出集群的20%进行升级。
  2. 回滚困难

  **注意事项**

  1. 滚动发布没有一个确定可行的环境。使用蓝绿部署，我们能够清晰地知道老版本是可行的，而使用滚动发布，我们无法确定。
  2. 修改了现有的环境。
  3. **回滚困难**。举个例子，在某一次发布中，我们需要更新100个实例，每次更新10个实例，每次部署需要5分钟。当滚动发布到第80个实例时，发现了问题，需要回滚，这个回滚却是一个痛苦，并且漫长的过程。
  4. 有的时候，我们还可能对系统进行动态伸缩，如果部署期间，系统自动扩容/缩容了，我们还需判断到底哪个节点使用的是哪个代码。尽管有一些自动化的运维工具，但是依然令人心惊胆战。
  5. 因为是逐步更新，那么我们在上线代码的时候，就会短暂出现新老版本不一致的情况，如果对上线要求较高的场景，那么就需要考虑如何做好兼容的问题。

- **灰度发布**

  灰度发布，也叫金丝雀发布。是指在黑与白之间，能够平滑过渡的一种发布方式。AB test就是一种灰度发布方式，让一部分用户继续用A，一部分用户开始用B，如果用户对B没有什么反对意见，那么逐步扩大范围，把所有用户都迁移到B上面来。灰度发布可以保证整体系统的稳定，在初始灰度的时候就可以发现、调整问题，以保证其影响度，而我们平常所说的金丝雀部署也就是灰度发布的一种方式。

  具体到服务器上, 实际操作中还可以做更多控制，譬如说，给最初更新的10台服务器设置较低的权重、控制发送给这10台服务器的请求数，然后逐渐提高权重、增加请求数。一种平滑过渡的思路, 这个控制叫做“流量切分”。

  ![v](http://assets.processon.com/chart_image/63645a260791292f5cdde377.png)

  【**发布流程**】

  1. 准备好部署各个阶段的工件，包括：构建工件，测试脚本，配置文件和部署清单文件。
  2. 将“金丝雀”服务器部署进服务器中，测试。
  3. 从负载均衡列表中移除掉“金丝雀”服务器。
  4. 升级“金丝雀”应用（排掉原有流量并进行部署）。
  5. 对应用进行自动化测试。
  6. 将“金丝雀”服务器重新添加到负载均衡列表中（连通性和健康检查）。
  7. 如果“金丝雀”在线使用测试成功，升级剩余的其他服务器。（否则就回滚）

- **蓝绿发布**

  蓝绿部署中，一共有两套系统：一套是正在提供服务系统（也就是上面说的旧版），标记为“绿色”；另一套是准备发布的系统，标记为“蓝色”。两套系统都是功能完善的，并且正在运行的系统，只是系统版本和对外服务情况不同。正在对外提供服务的老系统是绿色系统，新部署的系统是蓝色系统。

  ![img](http://assets.processon.com/chart_image/636456a9f346fb2f8d3c3660.png)

  **【发布流程】**

  比如有10台机器我们要去做系统升级。

  1. 先下线其中的5台机器。
  2. 升级之后把流量切换到升级的这5台机器。
  3. 再启动另外5台机器。
  4. 最后将流量都放进来。

  【**主要作用**】

  用来做发布前测试，测试过程中发现任何问题，可以直接在蓝色系统上修改，不干扰用户正在使用的系统。

  蓝色系统经过反复的测试、修改、验证，确定达到上线标准之后，直接将用户切换到蓝色系统，切换后的一段时间内，依旧是蓝绿两套系统并存，但是用户访问的已经是蓝色系统。这段时间内观察蓝色系统（新系统）工作状态，如果出现问题，直接切换回绿色系统。当确信对外提供服务的蓝色系统工作正常，不对外提供服务的绿色系统已经不再需要的时候，蓝色系统正式成为对外提供服务系统，成为新的绿色系统。 原先的绿色系统可以销毁，将资源释放出来，用于部署下一个蓝色系统。

  【**主要特点**】

  1. 蓝绿部署的目的是**减少发布时的中断时间**、**能够快速撤回发布**。
  2. 两套系统没有耦合的时候才能百分百保证不干扰。

  **【注意事项**】

  蓝绿部署只是上线策略中的一种，它不是可以应对所有情况的万能方案。 蓝绿部署能够简单快捷实施的前提假设是目标系统是非常内聚的，如果目标系统相当复杂，那么如何切换、两套系统的数据是否需要以及如何同步等，都需要仔细考虑。

  当你切换到蓝色环境时，需要妥当处理未完成的业务和新的业务。如果你的数据库后端无法处理，会是一个比较麻烦的问题：

  - 可能会出现需要同时处理“微服务架构应用”和“传统架构应用”的情况，如果在蓝绿部署中协调不好这两者，还是有可能会导致服务停止。
  - 需要提前考虑数据库与应用部署同步迁移/回滚的问题。
  - 蓝绿部署需要有基础设施支持。
  - 在非隔离基础架构（VM 、 Docker等）上执行蓝绿部署，蓝色环境和绿色环境有被摧毁的风险。

### A/B测试

A/B测试和蓝绿发布、滚动发布以及金丝雀发布，完全是两回事。

蓝绿发布、滚动发布和金丝雀是发布策略，目标是确保新上线的系统稳定，关注的是新系统的BUG、隐患。

A/B测试是效果测试，同一时间有多个版本的服务对外服务，这些服务都是经过足够测试，达到了上线标准的服务，有差异但是没有新旧之分（它们上线时可能采用了蓝绿部署的方式）。

A/B测试关注的是不同版本的服务的实际效果，譬如说转化率、订单情况等。

A/B测试时，线上同时运行多个版本的服务，这些服务通常会有一些体验上的差异，譬如说页面样式、颜色、操作流程不同。相关人员通过分析各个版本服务的实际效果，选出效果最好的版本。![4.jpg](http://dockone.io/uploads/article/20211207/3719de575570e60bcc81269c667fbf5d.jpg)
